<form id="baptismForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Baptism Date Selector -->
    <div style="text-align: center; margin: 20px;">
        <label for="baptismDate" style="font-size: 16px;">ðŸ“… Baptism Date:</label>
        <input type="date" id="baptismDate" name="baptism_date" value="{{ today }}" required
               style="padding: 10px; width: 90%; max-width: 400px; border-radius: 25px; 
                      border: 1px solid #ccc; font-size: 16px; text-align: center;">
    </div>

    <!-- Members List -->
    <ul style="list-style: none; padding: 0; margin: auto; max-width: 500px;">
        {% for member in eligible_members %}
            {% include 'sacraments/partials/_baptism_member_item.html' with member=member %}
        {% endfor %}
    </ul>

    <!-- Save Button -->
    <div style="text-align: center; margin-top: 20px;">
        <button type="submit" id="saveButton" 
                style="width: 90%; max-width: 400px; padding: 12px; background: #28a745; 
                       color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer;">
            âœ… Save Baptism
        </button>

        <!-- Hidden Saving Message -->
        <div id="savingMessage" style="display: none; margin-top: 10px; font-size: 16px; color: gray;">
            <span>Saving, please wait</span><span id="dots">.</span>
            <div class="spinner"></div>
        </div>
    </div>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const saveButton = document.getElementById("saveButton");
        const savingMessage = document.getElementById("savingMessage");

        document.getElementById("baptismForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent default form submission

            console.log("âœ… Form submission started...");

            let formData = new FormData(this);
            formData.append("baptism_date", document.getElementById("baptismDate").value);

            // Get selected members and ensure uniqueness
            let selectedMembers = new Set();
            document.querySelectorAll("input[name='selected_members']:checked").forEach(checkbox => {
                selectedMembers.add(checkbox.value);
            });

            // If no members selected, show error
            if (selectedMembers.size === 0) {
                alert("âš ï¸ Please select at least one member.");
                return;
            }

            // Convert Set to array and append each separately
            selectedMembers.forEach(member => formData.append("selected_members", member));

            // Handle certificate uploads
            selectedMembers.forEach(member => {
                let fileInput = document.getElementById(`certificate_${member}`);
                if (fileInput && fileInput.files.length > 0) {
                    formData.append(`certificate_${member}`, fileInput.files[0]);
                }
            });

            console.log("ðŸ“¤ Sending form data to Django:", formData);

            // Disable button to prevent duplicate submissions
            saveButton.disabled = true;
            saveButton.innerHTML = 'â³ Saving, please wait...';
            savingMessage.style.display = "block";

            // Send AJAX Request
            fetch("", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("âœ… Server Response:", data);
                if (data.message) {
                    alert("âœ… Baptism records updated successfully!");
                    window.location.href = "/sacraments/baptized-members/"; // Redirect
                } else {
                    alert("âŒ Error saving records: " + data.error);
                }
            })
            .catch(error => {
                console.error("âŒ Error during form submission:", error);
                alert("âŒ Error saving records! Check console for details.");
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = 'âœ… Save Baptism';
                savingMessage.style.display = "none";
            });
        });
    });
</script>