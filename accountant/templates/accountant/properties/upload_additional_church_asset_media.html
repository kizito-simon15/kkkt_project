{% extends 'accountant_base.html' %}

{% block content %}
<div class="container">
    <h2 class="header-title">üì∏ Upload Additional Media for "{{ church_asset.name }}"</h2>

    <!-- üñºÔ∏è Display Existing Media -->
    {% if existing_media %}
        <div class="existing-media-container">
            {% for media in existing_media %}
            <div class="media-item" id="media-{{ media.id }}">
                <img src="{{ media.image.url }}" alt="Asset Media" class="full-width-media">
                <button type="button" class="delete-button" data-media-id="{{ media.id }}">üóëÔ∏è Delete</button>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-media">No media available for this asset.</p>
    {% endif %}

    <!-- üì§ Form for Uploading Additional Media -->
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div id="formset-container">
            <div class="media-form">
                <h4>üì∑ Upload Additional Media</h4>
                <input type="file" name="image" class="image-upload" accept="image/*">
                <div class="preview-container">
                    <img class="image-preview" style="display: none;">
                </div>
            </div>
        </div>

        <!-- Add More Button -->
        <button type="button" id="add-more-button" class="add-more-button">‚ûï Add More</button>

        <!-- Submit & Cancel Buttons -->
        <button type="submit" class="upload-button">üì§ Upload</button>
        <a href="{% url 'accountant_church_asset_detail' church_asset.id %}" class="cancel-button">‚¨ÖÔ∏è Cancel</a>
    </form>
</div>

<!-- üé® CSS Styling - Prevents Shaking -->
<style>
    /* üìå General Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* üåü Main Container */
    .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        text-align: center;
        overflow-x: hidden; /* Prevent left-right movement */
    }

    /* üìå Prevent Viewport Shaking */
    html, body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }

    /* üè∑Ô∏è Header Title */
    .header-title {
        font-size: 20px;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 10px;
        margin-top: 40px; /* Adjusts spacing from topbar */
    }

    /* üñºÔ∏è Existing Media Section */
    .existing-media-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .media-item {
        position: relative;
        width: 100%;
        max-width: 350px; /* Limits size on large screens */
        text-align: center;
    }

    .full-width-media {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .delete-button {
        background: linear-gradient(135deg, #dc3545, #b02a37);
        color: white;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
        border: none;
        font-size: 14px;
        margin-top: 5px;
    }

    /* üì∑ Media Upload Block */
    .media-form {
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        width: 100%;
        max-width: 350px;
        margin: auto;
    }

    /* üì∑ Image Preview */
    .preview-container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 5px;
    }

    .image-preview {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* üì§ Upload & Add More Button */
    .upload-button, .add-more-button {
        background: #007bff;
        color: white;
        padding: 8px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        border: none;
    }

    /* ‚¨ÖÔ∏è Cancel Button */
    .cancel-button {
        background: #6c757d;
        color: white;
        padding: 8px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
    }

    /* ‚úÖ Responsive Fix for Phones */
    @media screen and (max-width: 768px) {
        .media-item,
        .media-form {
            max-width: 100%;
        }
    }
</style>

<!-- üõ†Ô∏è JavaScript for Managing Media -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formsetContainer = document.getElementById('formset-container');
        const addMoreButton = document.getElementById('add-more-button');

        // Function to handle image preview
        function handleImagePreview(input) {
            let preview = input.closest('.media-form').querySelector('.image-preview');
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.src = "";
                preview.style.display = "none";
            }
        }

        // Attach preview event listener to existing fields
        document.querySelectorAll('.image-upload').forEach(input => {
            input.addEventListener('change', function () {
                handleImagePreview(this);
            });
        });

        // Add More Functionality
        addMoreButton.addEventListener('click', function () {
            let newForm = document.createElement("div");
            newForm.classList.add("media-form");
            newForm.innerHTML = `
                <h4>üì∑ Upload Additional Media</h4>
                <input type="file" name="image" class="image-upload" accept="image/*">
                <div class="preview-container">
                    <img class="image-preview" style="display: none;">
                </div>
                <button type="button" class="remove-button">‚ùå Remove</button>
            `;
            formsetContainer.appendChild(newForm);

            // Attach preview event listener to new fields
            newForm.querySelector('.image-upload').addEventListener('change', function () {
                handleImagePreview(this);
            });

            // Remove Functionality
            newForm.querySelector('.remove-button').addEventListener('click', function () {
                newForm.remove();
            });
        });

        // Handle Media Deletion
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function () {
                const mediaId = this.dataset.mediaId;
                fetch(`/properties/delete-media/${mediaId}/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`media-${mediaId}`).remove();
                    }
                });
            });
        });
    });
</script>

{% endblock %}
