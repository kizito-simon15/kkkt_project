{% if leaders_distribution_data %}
    <h3>
        üßë‚Äçüíº Leaders Distribution Trend
        <button id="downloadLeadersTrendChart" style="background: none; border: none; cursor: pointer;">
            üì• Download Graph
        </button>
    </h3>

    <div class="leaders-trend-chart-wrapper">
        <canvas id="leadersTrendChart"></canvas>
    </div>

    <p id="leadersTrendAnalysis"></p>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .leaders-trend-chart-wrapper {
            max-width: 700px;
            margin: 0 auto;
            height: 400px;
            position: relative;
        }

        @media screen and (max-width: 600px) {
            .leaders-trend-chart-wrapper {
                max-width: 100%;
                height: 500px;
            }
        }
    </style>

    <script>
        // Parse JSON data from Django
        let leadersTrendData;
        try {
            leadersTrendData = JSON.parse('{{ leaders_distribution_data|safe }}');
            console.log("Leaders Trend Data:", leadersTrendData);
        } catch (e) {
            console.error("Error parsing leaders_distribution_data:", e);
            leadersTrendData = {
                cell_labels: ["No Data"],
                cell_data: [0],
                outstation_labels: ["No Data"],
                outstation_data: [0],
                analysis: "Error loading leadership data."
            };
        }

        let leadersTrendChart;  // Store Chart.js instance globally

        // Ensure canvas exists
        const canvas = document.getElementById('leadersTrendChart');
        if (!canvas) {
            console.error("Canvas element 'leadersTrendChart' not found.");
        } else {
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error("Failed to get 2D context for canvas.");
            } else {
                // Create chart with cell data only to avoid label mismatch
                leadersTrendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: leadersTrendData.cell_labels,
                        datasets: [
                            {
                                label: 'Leaders per Cell',
                                data: leadersTrendData.cell_data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Leaders per Outstation',
                                data: leadersTrendData.outstation_data.map((_, i) => {
                                    // Map outstation data to cell labels by finding matching outstation
                                    const cellOutstation = leadersTrendData.cell_labels[i];
                                    const outstationIndex = leadersTrendData.outstation_labels.indexOf(
                                        cellOutstation ? leadersTrendData.outstation_labels.find(ol => {
                                            return leadersTrendData.cell_labels.some(cl => {
                                                const cell = JSON.stringify(leadersTrendData.cell_labels).includes(cl);
                                                return cell && cl.includes(ol);
                                            });
                                        }) : "Unassigned"
                                    );
                                    return outstationIndex !== -1 ? leadersTrendData.outstation_data[outstationIndex] : 0;
                                }),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y;
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Leaders'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Cells'
                                },
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });

                // Display analysis
                document.getElementById("leadersTrendAnalysis").innerHTML = `<strong>${leadersTrendData.analysis}</strong>`;
            }
        }

        // Function to Download Chart as Image
        document.getElementById("downloadLeadersTrendChart").addEventListener("click", function() {
            if (leadersTrendChart) {
                const link = document.createElement('a');
                link.href = leadersTrendChart.toBase64Image();
                link.download = 'Leaders_Distribution_Trend.png';
                link.click();
            } else {
                console.error("No chart instance available for download.");
            }
        });
    </script>
{% else %}
    <p>No leadership data available.</p>
{% endif %}