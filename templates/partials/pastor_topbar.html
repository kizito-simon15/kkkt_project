{% load static %}

<!-- 
    Forcing the topbar to the bottom with inline style + !important
    height: 50px, etc.
-->
<div class="topbar"
     style="
       position: fixed !important;
       bottom: 0 !important;
       top: auto !important;
       left: 0 !important;
       right: 0 !important;
       z-index: 9999 !important;

       height: 50px !important; 
       padding: 5px 10px !important;
       box-sizing: border-box;
       max-width: 100vw;
       overflow: hidden;

       background: var(--topbar-background, linear-gradient(130deg, #007bff, #0056d2)) !important;
       color: var(--topbar-text-color, #fff) !important;
       border-top-left-radius: 15px;
       border-top-right-radius: 15px;
       border-bottom-left-radius: 0;
       border-bottom-right-radius: 0;
       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
       display: flex;
       align-items: center;
       justify-content: space-between;
     ">

    <!-- Toggle button (üçî) -->
    <div class="toggle-button" id="sidebarToggle" style="
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: background-color 0.3s ease;
    ">
        üçî
    </div>

    <!-- Search field (üîç) -->
    <div class="search-field" style="
        flex: 1;
        margin: 0 8px;
        display: flex;
        align-items: center;
        max-width: 400px;
        background-color: #fff;
        border-radius: 20px;
        padding: 3px 10px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    ">
        <input
            type="text"
            placeholder="Search links..."
            id="sidebarSearch"
            style="
                width: 100%;
                border: none;
                background: none;
                font-size: 14px;
                color: #333;
                outline: none;
                box-sizing: border-box;
            "
        />
        <span style="font-size: 20px;">üîç</span>
    </div>

    <!-- Icons: User, Notifications, Mode Selector, Logout -->
    <div class="topbar-icons" style="display: flex; align-items: center; gap: 10px;">
        
        <!-- Profile Picture (we'll preload via JavaScript) -->
        <a href="{% url 'pastor_upload_profile_picture' %}">
            <img
                id="memberProfileImg"
                alt="User Profile Picture"
                style="
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 2px solid #fff;
                    cursor: pointer;
                    transition: transform 0.3s ease;
                    display: none; /* Hide until it's fully loaded */
                "
            />
        </a>

        <!-- Notifications Icon (üîî) -->
        <span class="notifications" style="
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, color 0.3s ease;
        ">üîî</span>

        <!-- Mode Selector (Dropdown) -->
        <select id="modeSelector" style="font-size: 14px; padding: 4px; border-radius: 4px;">
          <option value="light">Light Mode</option>
          <option value="dark">Dark Mode</option>
          <option value="blue">Blue Mode</option>
          <option value="sepia">Sepia Mode</option>
          <option value="green">Green Mode</option>
          <option value="contrast">High Contrast</option>
          <option value="orange">Orange Mode</option>
          <option value="purple">Purple Mode</option>
          <option value="yellow">Yellow Mode</option>
          <option value="aqua">Aqua Mode</option>
          <option value="custom">Custom Mode</option>
        </select>

        <!-- Logout Icon (üö™) -->
        <a href="{% url 'logout' %}">
            <span class="logout" style="
                font-size: 20px;
                cursor: pointer;
                transition: transform 0.3s ease, color 0.3s ease;
            ">üö™</span>
        </a>
    </div>
</div>

<!-- Custom mode color pickers (hidden by default) -->
<div id="customPicker" 
     style="
       display: none; 
       position: fixed; 
       bottom: 60px; 
       right: 10px; 
       background-color: #fff; 
       padding: 10px; 
       border-radius: 8px; 
       box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
       font-family: sans-serif;
     ">
  <label style="margin-right: 8px;">
    BG Color <input type="color" id="customBgInput" style="vertical-align: middle;">
  </label>
  <label style="margin-right: 8px;">
    Text Color <input type="color" id="customTextInput" style="vertical-align: middle;">
  </label>
  <button id="customApplyBtn" 
          style="
            padding: 5px 10px; 
            border-radius: 4px; 
            background-color: #007bff; 
            color: #fff; 
            border: none; 
            cursor: pointer;
          ">
    Apply
  </button>
</div>

<script>
    /*************************************************************/
    /* 1) Preload the Member's Profile Picture (like a "cache")  */
    /*************************************************************/
    // If user has a profile picture, use that, otherwise fallback to user.png
    let memberProfileUrl = "{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/user.png' %}{% endif %}";
    
    const preloadedMemberImg = new Image();
    preloadedMemberImg.src = memberProfileUrl;

    preloadedMemberImg.onload = function() {
        const memberProfileImg = document.getElementById('memberProfileImg');
        memberProfileImg.src = preloadedMemberImg.src;
        memberProfileImg.style.display = 'block'; // Reveal once fully loaded
    };

    /*******************************************/
    /* 2) UI Mode / Theme Handling for Member  */
    /*******************************************/
    // Retrieve saved mode or default to 'light'
    const savedMode = localStorage.getItem('memberUiMode') || 'light';

    // Retrieve custom color selections (defaults if not found)
    const savedCustomBg = localStorage.getItem('memberCustomBg') || '#ffffff';
    const savedCustomText = localStorage.getItem('memberCustomText') || '#000000';

    // Function: Apply the chosen mode
    function applyMode(mode) {
      switch (mode) {
        case 'dark':
          document.documentElement.style.setProperty('--background-color', '#121212');
          document.documentElement.style.setProperty('--text-color', '#fff');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #333, #222)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'blue':
          document.documentElement.style.setProperty('--background-color', '#E7F3FF');
          document.documentElement.style.setProperty('--text-color', '#000');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #0066CC, #003366)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'sepia':
          document.documentElement.style.setProperty('--background-color', '#F5E9DA');
          document.documentElement.style.setProperty('--text-color', '#5B4636');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #C2A782, #9D8B6E)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'green':
          document.documentElement.style.setProperty('--background-color', '#E7FFE7');
          document.documentElement.style.setProperty('--text-color', '#004400');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #00AA00, #008800)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'contrast':
          document.documentElement.style.setProperty('--background-color', '#000');
          document.documentElement.style.setProperty('--text-color', '#fff');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #000, #000)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'orange':
          document.documentElement.style.setProperty('--background-color', '#FFF5E6');
          document.documentElement.style.setProperty('--text-color', '#CC6600');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #FF9900, #CC6600)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'purple':
          document.documentElement.style.setProperty('--background-color', '#F7F0FF');
          document.documentElement.style.setProperty('--text-color', '#4B0082');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #8A2BE2, #4B0082)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'yellow':
          document.documentElement.style.setProperty('--background-color', '#FFFFE0');
          document.documentElement.style.setProperty('--text-color', '#666600');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #FFFF00, #CCCC00)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'aqua':
          document.documentElement.style.setProperty('--background-color', '#E0FFFF');
          document.documentElement.style.setProperty('--text-color', '#006666');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #00FFFF, #00CCCC)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;

        case 'custom':
          // Use saved or newly chosen custom colors
          document.documentElement.style.setProperty('--background-color', savedCustomBg);
          document.documentElement.style.setProperty('--text-color', savedCustomText);
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, ' + savedCustomBg + ', ' + savedCustomBg + ')');
          document.documentElement.style.setProperty('--topbar-text-color', savedCustomText);
          break;

        case 'light':
        default:
          document.documentElement.style.setProperty('--background-color', '#fff');
          document.documentElement.style.setProperty('--text-color', '#000');
          document.documentElement.style.setProperty('--topbar-background', 'linear-gradient(130deg, #007bff, #0056d2)');
          document.documentElement.style.setProperty('--topbar-text-color', '#fff');
          break;
      }
    }

    // Apply the saved mode on page load
    applyMode(savedMode);

    // Initialize color pickers
    const customBgInput = document.getElementById('customBgInput');
    const customTextInput = document.getElementById('customTextInput');
    const customApplyBtn = document.getElementById('customApplyBtn');
    const customPicker = document.getElementById('customPicker');

    customBgInput.value = savedCustomBg;
    customTextInput.value = savedCustomText;

    // Mode selector
    const modeSelector = document.getElementById('modeSelector');
    if (modeSelector) {
      modeSelector.value = savedMode;
      customPicker.style.display = (savedMode === 'custom') ? 'block' : 'none';

      modeSelector.addEventListener('change', () => {
        const newMode = modeSelector.value;
        localStorage.setItem('memberUiMode', newMode);

        // Toggle the custom picker
        if (newMode === 'custom') {
          customPicker.style.display = 'block';
        } else {
          customPicker.style.display = 'none';
        }
        applyMode(newMode);
      });
    }

    // Custom mode apply button
    customApplyBtn.addEventListener('click', () => {
      const chosenBg = customBgInput.value;
      const chosenText = customTextInput.value;
      localStorage.setItem('memberCustomBg', chosenBg);
      localStorage.setItem('memberCustomText', chosenText);

      // Re-apply if still in custom mode
      if (modeSelector && modeSelector.value === 'custom') {
        applyMode('custom');
      }
    });
</script>
