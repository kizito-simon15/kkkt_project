{% extends 'member_base.html' %}

{% block content %}
<h2 style="text-align: center; color: #007bff; font-family: Arial, sans-serif; margin-top: 20px;">
    ðŸ’° Your Tithe Contributions
</h2>

<!-- âœ… iPhone-Like Filter Container -->
<div style="
    max-width: 600px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 15px;
    background: linear-gradient(135deg, #fef9d7 0%, #ffd3d3 100%);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 15px;
">

    <!-- Row 1: Year Filter -->
    <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    ">
        <label for="yearFilter" style="
            font-weight: bold;
            color: #333;
        ">Filter by Year:</label>
        <select id="yearFilter" style="
            padding: 10px;
            border-radius: 25px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 14px;
        ">
            <option value="">All Years</option>
            {% if tithes %}
                {% for tithe in tithes %}
                    <option value="{{ tithe.date_given|date:'Y' }}">{{ tithe.date_given|date:'Y' }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>

    <!-- Row 2: Date Filters -->
    <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    ">
        <label for="fromDate" style="
            font-weight: bold;
            color: #333;
        ">From:</label>
        <input type="date" id="fromDate" style="
            padding: 10px;
            border-radius: 25px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 14px;
        ">

        <label for="toDate" style="
            font-weight: bold;
            color: #333;
        ">To:</label>
        <input type="date" id="toDate" style="
            padding: 10px;
            border-radius: 25px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 14px;
        ">
    </div>

    <!-- Row 3: Total Amount -->
    <div style="
        text-align: center;
        font-family: Arial, sans-serif;
        color: #007bff;
        font-weight: bold;
        font-size: 1.1rem;
    ">
        Total Amount (TZS): <span id="totalAmount">0.00</span>
    </div>
</div>

<!-- âœ… Responsive Table Wrapper -->
<div style="overflow-x: auto; max-width: 100%; padding: 0 10px; box-sizing: border-box;">
    {% if tithes %}
        <table id="tithesTable" style="width: 100%; min-width: 800px; border-collapse: collapse; font-family: Arial, sans-serif;">
            <thead>
                <tr style="background-color: #007bff; color: white; text-align: center;">
                    <th style="padding: 10px;">S/N</th>
                    <th style="padding: 10px;">Receipt No.</th>
                    <th style="padding: 10px;">Amount (TZS)</th>
                    <th style="padding: 10px;">Payment Method</th>
                    <th style="padding: 10px;">Date Given (Since)</th>
                    <th style="padding: 10px;">Purpose</th>
                    <th style="padding: 10px;">Date Created</th>
                    <th style="padding: 10px;">Date Updated</th>
                </tr>
            </thead>
            <tbody>
                {% for tithe in tithes %}
                    <tr style="text-align: center; border-bottom: 1px solid #ddd;"
                        data-year="{{ tithe.date_given|date:'Y' }}"
                        data-date="{{ tithe.date_given }}"
                        data-amount="{{ tithe.amount }}">
                        <td style="padding: 8px;">{{ forloop.counter }}</td>
                        <td style="padding: 8px;">{{ tithe.receipt_number }}</td>
                        <td style="padding: 8px;" class="amount">{{ tithe.amount|floatformat:2 }}</td>
                        <td style="padding: 8px;">{{ tithe.payment_method }}</td>
                        <td style="padding: 8px;">
                            {{ tithe.date_given }} 
                            <br><small style="color: gray;">({{ tithe.time_since_given }})</small>
                        </td>
                        <td style="padding: 8px;">{{ tithe.purpose|default:"N/A" }}</td>
                        <td style="padding: 8px;">{{ tithe.date_created|date:"M d, Y H:i" }}</td>
                        <td style="padding: 8px;">{{ tithe.date_updated|date:"M d, Y H:i" }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; color: #888; font-style: italic; margin-top: 50px;">
            You have no tithes recorded yet.
        </p>
    {% endif %}
</div>

<!-- âœ… JavaScript for Filtering and Total Calculation -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const yearFilter = document.getElementById('yearFilter');
        const fromDate = document.getElementById('fromDate');
        const toDate = document.getElementById('toDate');
        const rows = document.querySelectorAll('#tithesTable tbody tr');
        const totalAmountDisplay = document.getElementById('totalAmount');

        // Remove duplicate years in the dropdown
        const seenYears = new Set();
        Array.from(yearFilter.options).forEach(option => {
            if (seenYears.has(option.value)) {
                option.remove();
            } else {
                seenYears.add(option.value);
            }
        });

        function filterTithes() {
            const selectedYear = yearFilter.value;
            const startDate = new Date(fromDate.value);
            const endDate = new Date(toDate.value);
            let totalAmount = 0;

            rows.forEach(row => {
                const rowYear = row.getAttribute('data-year');
                const rowDate = new Date(row.getAttribute('data-date'));
                const rowAmount = parseFloat(row.getAttribute('data-amount'));

                let isVisible = true;

                // Year Filter
                if (selectedYear && rowYear !== selectedYear) {
                    isVisible = false;
                }

                // Date Range Filter
                if (fromDate.value && rowDate < startDate) {
                    isVisible = false;
                }
                if (toDate.value && rowDate > endDate) {
                    isVisible = false;
                }

                // Toggle Row Visibility
                row.style.display = isVisible ? '' : 'none';

                // Add to total if row is visible
                if (isVisible) {
                    totalAmount += rowAmount;
                }
            });

            // Update the total amount
            totalAmountDisplay.textContent = totalAmount.toFixed(2);
        }

        // Event Listeners
        yearFilter.addEventListener('change', filterTithes);
        fromDate.addEventListener('change', filterTithes);
        toDate.addEventListener('change', filterTithes);

        // Calculate total on page load
        filterTithes();
    });
</script>
{% endblock %}
